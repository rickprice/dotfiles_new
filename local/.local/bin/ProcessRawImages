#! /usr/bin/sh

# Fail script if any command fails
set -e

## keep track of the last executed command
trap 'last_command=$current_command; current_command=$BASH_COMMAND' DEBUG
## echo an error message before exiting
trap 'echo "\"${last_command}\" command failed with exit code $?."' EXIT

WORKING_DIR=.
DROPBOX_DIR=./SendToDropBox
GOOGLEPHOTOS_DIR=./SendToGooglePhotos
LOCATION_HISTORY_FILE="Takeout/Location History/Location History.kml"

cd $WORKING_DIR 

mkdir -p $DROPBOX_DIR
mkdir -p $GOOGLEPHOTOS_DIR

echo Adding Geolocation data to RAW photos
exiftool -geotag "$LOCATION_HISTORY_FILE" '-geotime<${DateTimeOriginal}-04:00' . -api GeoMaxIntSecs=1800 -out $DROPBOX_DIR

echo Converting RAW photos to JGEG
# Convert files in batch mode using default parameters
rawtherapee-cli -d -o $GOOGLEPHOTOS_DIR -c $DROPBOX_DIR

# Remember we may need to enter password
figlet -k DropBox, You may need to enter passwword

# Move RAW files to DropBox
echo Moving RAW photos to DropBox
rclone move "$DROPBOX_DIR" Dropbox:Pictures/CanonRawPhotos

# Remember we may need to enter password
figlet -k Google Photos, You may need to enter passwword

# Move JPEG files to Google Photos
echo Moving JPEG photos to Google Photos
rclone move "$GOOGLEPHOTOS_DIR" GooglePhotos:upload

# Start terminal to watch the pipeline
terminal -e watch --interval 120 "ls SendToDropBox SendToGooglePhotos | wc --lines | figlet -k"

